<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مدرسة أم القرى الخاصة - بيانات التواصل</title>

  <!-- Cairo -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase JS v2 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#f4fbf9;
      --bg2:#eef7ff;
      --card: rgba(255,255,255,.92);
      --text:#0b1220;
      --muted:#5b6b7b;
      --border: rgba(15, 23, 42, .10);

      --primary:#0ea5a4;
      --primary2:#16a34a;
      --accent:#0b3b5a;

      --shadow: 0 18px 55px rgba(2, 6, 23, .12);
      --radius:20px;
    }

    html, body{
      font-family:"Cairo", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *, button, input, select, textarea{
      font-family:"Cairo", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif !important;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      direction: rtl;
      background:
        radial-gradient(900px 500px at 80% 10%, rgba(14,165,164,.18), transparent 60%),
        radial-gradient(800px 480px at 15% 15%, rgba(22,163,74,.12), transparent 55%),
        radial-gradient(700px 420px at 50% 110%, rgba(59,130,246,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    .page{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px 14px;
    }

    .card{
      width:min(760px, 100%);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      backdrop-filter: blur(10px);
    }

    /* ملاحظة بارزة باللون الأحمر */
    .alert-note{
      border: 1px solid rgba(220, 38, 38, .28);
      background: rgba(220, 38, 38, .08);
      color: #b91c1c;
      border-radius: 16px;
      padding: 12px 12px;
      font-weight: 900;
      line-height: 1.8;
      margin-bottom: 14px;
      text-align: center;
    }
    .alert-note strong{
      color: #7f1d1d;
    }

    .header{
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }

    .app-logo {
      width: 200px;
      height: 200px;
      background: white url('images/logo.png') no-repeat center center;
      background-size: contain;
      border-radius: 50%;
      border: 1px solid rgba(2, 6, 23, .10);
      box-shadow: 0 12px 30px rgba(2,6,23,.10);
    }
    @media (max-width: 480px) {
      .app-logo { width: 120px; height: 120px; }
    }
    @media (min-width: 481px) and (max-width: 768px) {
      .app-logo { width: 160px; height: 160px; }
    }

    .title{
      margin:0;
      font-size:clamp(20px, 3.2vw, 30px);
      letter-spacing:.2px;
      color: var(--accent);
    }
    .subtitle{
      margin:10px 0 14px;
      color:var(--muted);
      line-height:1.9;
      text-align:center;
      font-size:14.8px;
    }

    .steps{
      display:flex;
      justify-content:center;
      gap:10px;
      margin:10px 0 16px;
    }
    .step{
      width:38px;height:38px;
      display:flex;align-items:center;justify-content:center;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background: rgba(255,255,255,.65);
      font-weight:800;
      user-select:none;
    }
    .step.is-active{
      border-color: rgba(14,165,164,.35);
      color: #075985;
      background: linear-gradient(135deg, rgba(14,165,164,.18), rgba(22,163,74,.16));
    }

    .section-title{
      margin:0 0 12px;
      font-size:16px;
      color: #0f2a3a;
    }

    .form-step{display:none; animation:fadeUp .22s ease both;}
    .form-step.is-active{display:block;}
    @keyframes fadeUp{
      from{opacity:0; transform:translateY(8px)}
      to{opacity:1; transform:translateY(0)}
    }

    .field{margin:12px 0}
    label{display:block; font-weight:800; margin-bottom:6px; font-size:14px;}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      outline:none;
      font-size:14px;
      background: rgba(255,255,255,.85);
    }
    input:focus, select:focus{
      border-color: rgba(14,165,164,.50);
      box-shadow: 0 0 0 4px rgba(14,165,164,.14);
    }
    .hint{display:block; margin-top:6px; color:var(--muted); font-size:12.5px; line-height:1.6}

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 640px){
      .grid2{grid-template-columns:1fr;}
    }

    .check{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin:14px 0 6px;
      color:var(--text);
      line-height:1.8;
    }
    .check input{width:18px; height:18px; margin-top:4px}

    .actions{
      display:flex;
      gap:10px;
      margin-top:14px;
      justify-content:space-between;
    }
    .btn{
      border:0;
      border-radius:14px;
      padding:11px 14px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, background .12s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.65; cursor:not-allowed}

    .btn-primary{
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#fff;
      box-shadow: 0 12px 28px rgba(14,165,164,.18);
      width: 50%;
    }
    .btn-primary:hover{filter: brightness(1.03)}
    .btn-ghost{
      background: rgba(255,255,255,.75);
      color:var(--text);
      border:1px solid var(--border);
      width: 45%;
    }
    @media (max-width: 520px){
      .actions{flex-direction:column}
      .btn-primary,.btn-ghost{width:100%}
    }

    .status{
      margin-top:12px;
      font-size:14px;
      color:var(--muted);
      min-height:22px;
      text-align:center;
    }
    .status.ok{color:#0f766e}
    .status.err{color:#b91c1c}

    .thankyou{
      text-align:center;
      padding:14px 10px 6px;
      animation: fadeUp .22s ease both;
    }
    .thankyou-box{
      margin-top:14px;
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      background: linear-gradient(135deg, rgba(14,165,164,.10), rgba(22,163,74,.08));
    }
    .big-check{
      width:64px;height:64px;
      margin:0 auto 10px;
      border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(22,163,74,.12);
      border: 1px solid rgba(22,163,74,.25);
      color: #166534;
      font-weight: 900;
      font-size: 28px;
    }
  </style>
</head>

<body>
  <main class="page">
    <section class="card">

      <!-- الملاحظة البارزة (بداية الصفحة) -->
      <div class="alert-note">
        <strong>تنبيه مهم:</strong> يرجى استخدام <strong>الأرقام الإنجليزية</strong> عند كتابة (رقم الموبايل / رقم الشعبة) مثل: 1 2 3
      </div>

      <header class="header">
        <div class="app-logo" aria-label="شعار المدرسة"></div>
        <h1 class="title">مدرسة أم القرى الخاصة</h1>
      </header>

      <p class="subtitle">
        حرصاً من إدارة مدرسة أم القرى الخاصة على سرعة التواصل مع أولياء الأمور, نرجو منكم التفضل بتعبئة البيانات التالية بدقة.
      </p>

      <div class="steps" id="stepsBar">
        <div class="step is-active">1</div>
        <div class="step">2</div>
        <div class="step">3</div>
      </div>

      <form id="form" novalidate>
        <!-- Step 1 -->
        <section class="form-step is-active" data-step="1">
          <h2 class="section-title">بيانات الطالب</h2>

          <div class="field">
            <label for="student_name">اسم الطالب بالكامل</label>
            <input id="student_name" name="student_name" type="text" placeholder="اكتب اسم الطالب" required />
            <small class="hint">مثال: مصطفى تامر مصطفى ابراهيم</small>
          </div>

          <div class="field">
            <label for="parent_name">اسم ولي الأمر</label>
            <input id="parent_name" name="parent_name" type="text" placeholder="اكتب اسم ولي الأمر" required />
          </div>

          <div class="actions">
            <button type="button" class="btn btn-primary" data-next>التالي</button>
          </div>
        </section>

        <!-- Step 2 -->
        <section class="form-step" data-step="2">
          <h2 class="section-title">المرحلة والفصل</h2>

          <div class="grid2">
            <div class="field">
              <label for="stage">المرحلة</label>
              <select id="stage" name="stage" required>
                <option value="" selected disabled>اختر المرحلة</option>
                <option value="رياض اطفال">رياض أطفال</option>
                <option value="ابتدائي">ابتدائي</option>
                <option value="اعدادي">إعدادي</option>
              </select>
            </div>

            <div class="field">
              <label for="class_name">الفصل</label>
              <select id="class_name" name="class_name" required>
                <option value="" selected disabled>اختر الفصل</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="section_number">رقم الشعبة (1 إلى 8)</label>
            <input id="section_number" name="section_number" type="number" min="1" max="8" inputmode="numeric" placeholder="مثال: 3" required />
          </div>

          <div class="actions">
            <button type="button" class="btn btn-ghost" data-prev>السابق</button>
            <button type="button" class="btn btn-primary" data-next>التالي</button>
          </div>
        </section>

        <!-- Step 3 -->
        <section class="form-step" data-step="3">
          <h2 class="section-title">بيانات التواصل</h2>

          <div class="field">
            <label for="parent_mobile">رقم موبايل ولي الأمر</label>
            <input id="parent_mobile" name="parent_mobile" type="tel" inputmode="tel" placeholder="01xxxxxxxxx" required />
            <small class="hint">يفضل كتابة الرقم بدون مسافات، ويجب أن يكون رقم ولي الأمر الفعّال.</small>
          </div>

          <label class="check">
            <input id="confirm_owner" name="confirm_owner" type="checkbox" required />
            <span>أؤكد أن الرقم المسجل يخص ولي الأمر وليس الطالب وأن يكون رقم فعال.</span>
          </label>

          <div class="actions">
            <button type="button" class="btn btn-ghost" data-prev>السابق</button>
            <button type="submit" class="btn btn-primary" id="submitBtn">إرسال</button>
          </div>

          <div class="status" id="status" aria-live="polite"></div>
        </section>
      </form>

      <!-- Thank You Screen -->
      <section id="thankYou" class="thankyou" hidden>
        <div class="thankyou-box">
          <div class="big-check">✓</div>
          <h2 class="section-title" style="margin-bottom:6px;">شكراً لولي الأمر</h2>
          <p class="subtitle" id="thankText" style="margin:0;">
            تم استلام بياناتكم بنجاح، شاكرين تعاونكم.
          </p>

          <div class="actions" style="margin-top:16px; justify-content:center;">
            <button type="button" class="btn btn-primary" id="newEntryBtn" style="width:min(320px,100%);">
              إدخال بيانات جديدة
            </button>
          </div>
        </div>
      </section>

    </section>
  </main>

  <script>
    // ====== Supabase Config ======
    const SUPABASE_URL = "https://exjfmrguqqvyclcmuzks.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4amZtcmd1cXF2eWNsY211emtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNTE0MTMsImV4cCI6MjA4MTYyNzQxM30.jgo6xOjHWOMbwQftZW-IEq967_JxsJ2CDVpeH3L8gNc";

    // CDN: createClient من المتغير العالمي supabase. [web:35][web:36]
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // [web:35]

    // ====== DOM ======
    const form = document.getElementById("form");
    const statusEl = document.getElementById("status");
    const submitBtn = document.getElementById("submitBtn");

    const stepsBar = document.getElementById("stepsBar");
    const stepsDots = document.querySelectorAll(".step");
    const steps = document.querySelectorAll(".form-step");

    const stageEl = document.getElementById("stage");
    const classEl = document.getElementById("class_name");

    const thankYouEl = document.getElementById("thankYou");
    const newEntryBtn = document.getElementById("newEntryBtn");
    const thankText = document.getElementById("thankText");

    // ====== Data ======
    const classesByStage = {
      "رياض اطفال": ["KG1", "KG2"],
      "ابتدائي": [
        "الأول الابتدائي", "الثاني الابتدائي", "الثالث الابتدائي",
        "الرابع الابتدائي", "الخامس الابتدائي", "السادس الابتدائي"
      ],
      "اعدادي": ["الأول الإعدادي", "الثاني الإعدادي", "الثالث الإعدادي"]
    };

    function setStatus(msg, type){
      statusEl.classList.remove("ok","err");
      if(type) statusEl.classList.add(type);
      statusEl.textContent = msg || "";
    }

    function goStep(n){
      steps.forEach(s => s.classList.toggle("is-active", s.dataset.step === String(n)));
      stepsDots.forEach((d, i) => d.classList.toggle("is-active", i === (n-1)));
      setStatus("");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function currentStep(){
      const active = document.querySelector(".form-step.is-active");
      return Number(active?.dataset.step || 1);
    }

    function validateStep(n){
      const step = document.querySelector(`.form-step[data-step="${n}"]`);
      const requiredInputs = step.querySelectorAll("input[required], select[required]");
      for (const el of requiredInputs){
        if(el.type === "checkbox" && !el.checked) return false;
        if(el.type !== "checkbox" && !String(el.value || "").trim()) return false;

        if(el.id === "section_number"){
          const v = Number(el.value);
          if(!(v >= 1 && v <= 8)) return false;
        }
      }
      return true;
    }

    document.querySelectorAll("[data-next]").forEach(btn => {
      btn.addEventListener("click", () => {
        const n = currentStep();
        if(!validateStep(n)){
          setStatus("من فضلك أكمل بيانات هذه الصفحة بشكل صحيح.", "err");
          return;
        }
        goStep(n + 1);
      });
    });

    document.querySelectorAll("[data-prev]").forEach(btn => {
      btn.addEventListener("click", () => goStep(currentStep() - 1));
    });

    stageEl.addEventListener("change", () => {
      const stage = stageEl.value;
      const list = classesByStage[stage] || [];

      classEl.innerHTML = `<option value="" selected disabled>اختر الفصل</option>`;
      list.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        classEl.appendChild(opt);
      });
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if(!validateStep(3)){
        setStatus("من فضلك أكمل بيانات هذه الصفحة بشكل صحيح.", "err");
        return;
      }

      submitBtn.disabled = true;
      setStatus("جارٍ الإرسال...");

      const parentName = document.getElementById("parent_name").value.trim();

      const payload = {
        student_name: document.getElementById("student_name").value.trim(),
        parent_name: parentName,
        stage: stageEl.value,
        class_name: classEl.value,
        section_number: Number(document.getElementById("section_number").value),
        parent_mobile: document.getElementById("parent_mobile").value.trim(),
        confirm_owner: document.getElementById("confirm_owner").checked
      };

      try {
        // Insert [web:14]
        const { error } = await sb
          .from("parent_contacts")
          .insert(payload);

        if(error) throw error;

        thankText.textContent = `شكراً للأستاذ/ة ${parentName}، تم استلام بياناتكم بنجاح، شاكرين تعاونكم.`;

        setStatus("");
        form.hidden = true;
        stepsBar.hidden = true;
        thankYouEl.hidden = false;

        window.scrollTo({ top: 0, behavior: "smooth" });
      } catch (err) {
        setStatus(`تعذر الإرسال: ${err.message || err}`, "err");
      } finally {
        submitBtn.disabled = false;
      }
    });

    newEntryBtn.addEventListener("click", () => {
      thankYouEl.hidden = true;
      form.hidden = false;
      stepsBar.hidden = false;

      form.reset();
      classEl.innerHTML = `<option value="" selected disabled>اختر الفصل</option>`;
      setStatus("");
      goStep(1);
    });

    goStep(1);
  </script>
</body>
</html>
